<?xml version="1.0" encoding="utf-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="WarLibraries" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <library name="BuildStation">
      <params>
        <param name="TargetSector"/>
        <param name="Faction"/>
        <param name="StationTag"/>
        <param name="StationType"/>
        <param name="Level" default="0.9"/>
        <param name="Radius" default="5km"/>
        <param name="MaxDistance" default="100km"/>
        <param name="AllowYaxis" default="false"/>
        <param name="DebugChance" default="0"/>
      </params>
      <actions>
        <do_if value="$TargetSector != null">
          <set_value name="$Station" exact="null"/>
          <set_value name="$StationMacro" exact="null"/>
          <set_value name="$SafePosition" exact="null"/>
          <set_value name="$ConstructionPlan" exact="null"/>
          <set_value name="$Loadouts" exact="null"/>
          <set_value name="$BuildID" exact="null"/>
          <get_construction_plan result="$ConstructionPlan" faction="$Faction" tags="$StationTag"/>
          <do_if value="$ConstructionPlan">
            <get_module_set_macro result="$StationMacro" race="$Faction.primaryrace" type="$StationType"/>
            <get_safe_pos result="$SafePosition" sector="$TargetSector" radius="$Radius" object="$TargetSector" max="$MaxDistance" allowyaxis="$AllowYaxis"/>
            <create_station name="$Station" sector="$TargetSector" owner="$Faction" macro="$StationMacro">
              <safepos value="$SafePosition"/>
            </create_station>
            <generate_loadout sequence="$ConstructionPlan" level="$Level" result="$Loadouts" faction="$Faction"/>
            <do_all exact="$Loadouts.count" counter="$l">
              <apply_loadout sequence="$ConstructionPlan" index="$l" loadout="$Loadouts.{$l}"/>
            </do_all>
            <add_build_to_expand_station object="$Station.buildstorage" buildobject="$Station" constructionplan="$ConstructionPlan" result="$BuildID"/>
            <signal_cue cue="FWM_Station_Management"/>
            <debug_text text="'Started construction of station ' + $Station.knownname + ' ' + $Station + ' - Build ID: ' + $BuildID" context="false" chance="$DebugChance"/>
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'No TargetSector given'" chance="$DebugChance"/>
        </do_else>
      </actions>
      <cues>
        <cue name="FWM_Station_Management" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$StationConstructed" exact="false"/>
            <do_if value="$Station.exists">
              <debug_text text="'FWM_Station_Management triggered'" context="false" chance="$DebugChance"/>
            </do_if>
            <do_else>
              <assert value="$Station.exists" text="'Station does not exist. This cue should not have been signalled.'"/>
              <reset_cue cue="this"/>
            </do_else>
          </actions>
          <cues>
            <cue name="Station_UnderConstruction" comment="not instantiated intentionally, so it triggers only once - even if multiple modules are being built!">
              <conditions>
                <event_build_finished object="$Station"/>
              </conditions>
              <actions>
                <debug_text text="'Station_UnderConstruction cue triggered'" context="false" chance="$DebugChance"/>
              </actions>
            </cue>
            <cue name="Station_Destroyed">
              <conditions>
                <event_object_destroyed object="$Station"/>
              </conditions>
              <actions>
                <debug_text text="'Station_Destroyed cue triggered'" context="false" chance="$DebugChance"/>
                <set_value name="$Station" exact="null"/>
                <reset_cue cue="FWM_Station_Management"/>
              </actions>
            </cue>
            <cue name="Station_Completed">
              <conditions>
                <event_build_finished object="$Station.buildstorage"/>
              </conditions>
              <actions>
                <debug_text text="player.age + ': Station ' + $Station.knownname + ' ' + $Station + ' has finished building.'" context="false" chance="$DebugChance"/>
                <set_value name="$StationConstructed" exact="true"/>
              </actions>
            </cue>
          </cues>
        </cue>
      </cues>
    </library>
  </cues>
</mdscript>