<?xml version="1.0" encoding="utf-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="WarLibraries" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <library name="BuildStation" instantiate="true" >
      <params>
        <param name="Level" default="0.9"/>
        <param name="Radius" default="5km"/>
        <param name="MaxDistance" default="100km"/>
        <param name="AllowYaxis" default="false"/>
        <param name="DebugChance" default="100"/>
        <param name="DebugChance2" default="0"/>
      </params>
		<conditions>
			<event_cue_signalled/>
		</conditions>
      <actions>
        <set_value name="$TargetSector" exact="event.param.{1}"/>
        <set_value name="$Faction" exact="event.param.{2}"/>
        <set_value name="$StationTag" exact="event.param.{3}"/>
        <set_value name="$StationType" exact="event.param.{4}"/>
        <set_value name="$DebugChance" exact="event.param.{5}"/>        
		<debug_text text="'BuildStation: TargetSector %1, Faction %2, StationTag %3, StationType %4, DebugChance %5'.[$TargetSector.knownname, $Faction.id, $StationTag, $StationType, $DebugChance]" chance="100"/>
        <do_if value="$TargetSector != null">
          <set_value name="$Station" exact="null"/>
          <set_value name="$StationMacro" exact="null"/>
          <set_value name="$SafePosition" exact="null"/>
          <set_value name="$ConstructionPlan" exact="null"/>
          <set_value name="$Loadouts" exact="null"/>
          <set_value name="$BuildID" exact="null"/>
          <get_construction_plan result="$ConstructionPlan" faction="$Faction" tags="$StationTag"/>
          <do_if value="$ConstructionPlan">
            <get_module_set_macro result="$StationMacro" race="$Faction.primaryrace" type="$StationType"/>
            <get_safe_pos result="$SafePosition" sector="$TargetSector" radius="$Radius" object="$TargetSector" max="$MaxDistance" allowyaxis="$AllowYaxis"/>
            <create_station name="$Station" sector="$TargetSector" owner="$Faction" macro="$StationMacro">
              <safepos value="$SafePosition"/>
            </create_station>
            <debug_text text="'Station exists after creation %1'.[$Station.exists]" chance="$DebugChance2"/>
            <generate_loadout sequence="$ConstructionPlan" level="$Level" result="$Loadouts" faction="$Faction"/>
            <do_all exact="$Loadouts.count" counter="$l">
              <apply_loadout sequence="$ConstructionPlan" index="$l" loadout="$Loadouts.{$l}"/>
            </do_all>
            <add_build_to_expand_station object="$Station.buildstorage" buildobject="$Station" constructionplan="$ConstructionPlan" result="$BuildID"/>
            <debug_text text="'Started construction of station ' + $Station.knownname + ' ' + $Station + ' - Build ID: ' + $BuildID" chance="$DebugChance"/>
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'No TargetSector given'" chance="$DebugChance2"/>
          <cancel_cue cue="this"/>
        </do_else>
      </actions>
      <cues>
        <cue name="FWM_Station_Management_Evaluation" instantiate="true">
		  <delay exact="60s"/>
          <actions>
			<debug_text text="'FWM_Station_Management_Evaluation'" chance="100"/>
            <do_all exact="$Station.buildstorage.resources.list.count" counter="$i">
              <set_value name="$Ware" exact="$Station.buildstorage.resources.list.{$i}"/>
              <debug_text text="'%1 has %2 %3 neededsequenceresources %4 buyprice %5'.[$Station.knownname,$Station.buildstorage.cargo.{$Ware}.count,$Ware,$Station.buildingprocessor.neededsequenceresources.{$Ware}.count,$Station.buildstorage.buyprice.{$Ware}]" chance="$DebugChance"/>
              <set_value name="$Offers" exact="[]"/>
              <find_buy_offer tradepartner="player.container" usereservations="false" excludeempty="false" result="$Offers" multiple="true" buyer="$Station.buildstorage" wares="$Ware"/>
              <do_all exact="$Offers.count" counter="$k">
                <set_value name="$TradeOffer" exact="$Offers.{$k}"/>
                <debug_text text="'Buy offer %1: price: %2 - unitprice: %3 - minprice: %4 - relativeprice: %5'.[$Ware,$TradeOffer.price,$TradeOffer.unitprice,$TradeOffer.minprice,$TradeOffer.relativeprice]" chance="$DebugChance2"/>
              </do_all>
            </do_all>			
            <reset_cue cue="FWM_Station_Management_Evaluation"/>
          </actions>
        </cue>
        <cue name="TradeCompleted" instantiate="true">
          <conditions>
            <event_trade_completed buyer="$Station.buildstorage"/>
          </conditions>
          <actions>
            <set_value name="$Trade" exact="event.param"/>
            <debug_text text="'Trade Completed %1: price: %2 - unitprice: %3 - minprice: %4 - relativeprice: %5'.[$Trade.ware,$Trade.price,$Trade.unitprice,$Trade.minprice,$Trade.relativeprice]" chance="$DebugChance2"/>
          </actions>
        </cue>
        <cue name="TradeStarted" instantiate="true">
          <conditions>
            <event_trade_started buyer="$Station.buildstorage"/>
          </conditions>
          <actions>
            <set_value name="$Trade" exact="event.param"/>
            <debug_text text="'Trade Started %1: price: %2 - unitprice: %3 - minprice: %4 - relativeprice: %5'.[$Trade.ware,$Trade.price,$Trade.unitprice,$Trade.minprice,$Trade.relativeprice]" chance="$DebugChance2"/>
          </actions>
        </cue>
      </cues>
    </library>
  </cues>
</mdscript>
