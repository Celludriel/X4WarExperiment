<?xml version="1.0" encoding="utf-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="WarLibraries" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <library name="BuildStation">
      <params>
        <param name="TargetSector"/>
        <param name="Faction"/>
        <param name="StationTag"/>
        <param name="StationType"/>
        <param name="SpaceToCommandeerShipsIn"/>
        <param name="Level" default="0.9"/>
        <param name="Radius" default="5km"/>
        <param name="MaxDistance" default="100km"/>
        <param name="AllowYaxis" default="false"/>
        <param name="DebugChance" default="0"/>
        <param name="DebugChance2" default="0"/>
      </params>
      <actions>
		<debug_text text="'SpaceToCommandeerShipsIn: %1'.[$SpaceToCommandeerShipsIn]" chance="$DebugChance"/>
        <do_if value="$TargetSector != null">
          <set_value name="$Station" exact="null"/>
          <set_value name="$StationMacro" exact="null"/>
          <set_value name="$SafePosition" exact="null"/>
          <set_value name="$ConstructionPlan" exact="null"/>
          <set_value name="$Loadouts" exact="null"/>
          <set_value name="$BuildID" exact="null"/>
          <get_construction_plan result="$ConstructionPlan" faction="$Faction" tags="$StationTag"/>
          <do_if value="$ConstructionPlan">
            <get_module_set_macro result="$StationMacro" race="$Faction.primaryrace" type="$StationType"/>
            <get_safe_pos result="$SafePosition" sector="$TargetSector" radius="$Radius" object="$TargetSector" max="$MaxDistance" allowyaxis="$AllowYaxis"/>
            <create_station name="$Station" sector="$TargetSector" owner="$Faction" macro="$StationMacro">
              <safepos value="$SafePosition"/>
            </create_station>
            <debug_text text="'Station exists after creation %1'.[$Station.exists]" chance="$DebugChance2"/>
            <generate_loadout sequence="$ConstructionPlan" level="$Level" result="$Loadouts" faction="$Faction"/>
            <do_all exact="$Loadouts.count" counter="$l">
              <apply_loadout sequence="$ConstructionPlan" index="$l" loadout="$Loadouts.{$l}"/>
            </do_all>
            <add_build_to_expand_station object="$Station.buildstorage" buildobject="$Station" constructionplan="$ConstructionPlan" result="$BuildID"/>
            <debug_text text="'Started construction of station ' + $Station.knownname + ' ' + $Station + ' - Build ID: ' + $BuildID" chance="$DebugChance"/>
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'No TargetSector given'" chance="$DebugChance2"/>
          <cancel_cue cue="this"/>
        </do_else>
      </actions>
      <cues>
        <cue name="FWM_Station_Management_Evaluation">
			<delay exact="60s"/>
			<actions>
				<do_all exact="$Station.buildstorage.resources.list.count" counter="$i">
					<set_value name="$Ware" exact="$Station.buildstorage.resources.list.{$i}" />
					<debug_text text="'%1 has %2 %3 neededsequenceresources %4'.[$Station.knownname,$Station.buildstorage.cargo.{$Ware}.count,$Ware,$Station.buildingprocessor.neededsequenceresources.{$Ware}.count]" chance="$DebugChance"/>
				</do_all>
				<reset_cue cue="FWM_Station_Management_Evaluation"/>
			</actions>
        </cue>
      </cues>
    </library>
  </cues>
</mdscript>
